/*

Calculate each user's average session time, where a session is defined as the time difference between a page_load and a page_exit.
Assume each user has only one session per day. If there are multiple page_load or page_exit events on the same day, use only the latest page_load and the earliest page_exit. 
Only consider sessions where the page_load occurs before the page_exit on the same day. Output the user_id and their average session time.
https://platform.stratascratch.com/coding/10352-users-by-avg-session-time?code_type=3

*/




WITH load_time AS
(
SELECT 
    user_id,
    DATE(timestamp) AS session_date, 
    MAX(CASE WHEN action = 'page_load' THEN timestamp END) AS latest_page_load, 
    MIN(CASE WHEN action = 'page_exit' THEN timestamp END) AS earliest_exit 
FROM facebook_web_log
GROUP BY user_id, DATE(timestamp)
), 
session_cal AS
(
SELECT 
    user_id,
    latest_page_load, 
    earliest_exit, 
    session_date, 
    CASE 
    WHEN latest_page_load < earliest_exit 
    THEN TIMESTAMPDIFF (SECOND,latest_page_load,earliest_exit)
    ELSE NULL 
    END AS session_duration
FROM load_time
WHERE latest_page_load IS NOT NULL AND earliest_exit IS NOT NULL 
) 


SELECT user_id, AVG(session_duration)
FROM session_cal
WHERE session_duration IS NOT NULL
GROUP BY user_id;
